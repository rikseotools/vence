// components/TestPageWrapper.js - ACTUALIZACI√ìN PARA ARTICULOS-DIRIGIDO
'use client'
import { useState, useEffect } from 'react'
import { useSearchParams } from 'next/navigation'
import TestLayout from './TestLayout'
import OposicionDetector from './OposicionDetector'
import { 
  fetchRandomQuestions,
  fetchQuickQuestions, 
  fetchOfficialQuestions,
  fetchPersonalizedQuestions,
  fetchQuestionsByTopicScope,  // üéØ NUEVO: Para temas multi-ley
  fetchArticulosDirigido,      // üÜï NUEVO: Para art√≠culos dirigidos
  fetchMantenerRacha,          // üÜï NUEVO: Para mantener rachas
  fetchExplorarContenido,      // üÜï NUEVO: Para explorar contenido
  fetchAleatorioMultiTema      // üé≤ NUEVO: Para tests aleatorios con m√∫ltiples temas
} from '../lib/testFetchers'

export default function TestPageWrapper({
  // üéØ Props obligatorias
  tema,
  testType, // 'aleatorio', 'personalizado', 'rapido', 'oficial', 'articulos-dirigido', etc.
  
  // üéØ Props de personalizaci√≥n (opcionales)
  customTitle,
  customDescription,
  customIcon,
  customColor,
  customSubtitle,
  
  // üéØ Props de configuraci√≥n (opcionales)
  defaultConfig = {},
  customQuestionFetcher = null,
  
  // üÜï NUEVAS PROPS PARA ARTICULOS-DIRIGIDO
  lawName,
  searchParams: propsSearchParams, // Desde la p√°gina server component
  
  // üé≤ NUEVA PROP PARA TESTS ALEATORIOS MULTI-TEMA
  themes, // Array de IDs de temas para tests aleatorios
  
  // üéØ Props de UI (opcionales)
  loadingMessage,
  errorMessage
}) {
  // Estados b√°sicos
  const [questions, setQuestions] = useState([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState(null)
  const [config, setConfig] = useState(null)

  // üÜï USAR searchParams desde props si es de notificaci√≥n, sino usar hook
  const hookSearchParams = useSearchParams()
  const finalSearchParams = propsSearchParams || hookSearchParams

 // üéØ Funci√≥n para detectar fetcher correcto seg√∫n el tema
  const getFetcherForTema = (tema, testType) => {
    // üé≤ NUEVO: Para tests aleatorios multi-tema
    if (testType === 'aleatorio' && themes && themes.length > 0) {
      console.log(`üé≤ Test aleatorio multi-tema: ${themes.length} temas`)
      return fetchAleatorioMultiTema
    }
    
    // ‚úÖ NUEVO: Usar siempre fetchQuestionsByTopicScope para temas
    // La funci√≥n autom√°ticamente detectar√° si es multi-ley desde topic_scope
    if (tema && tema > 0) {
      console.log(`üéØ Tema ${tema} usando fetcher din√°mico (topic_scope)`)
      return fetchQuestionsByTopicScope
    }
    
    // Para tests sin tema espec√≠fico, usar fetchers espec√≠ficos por tipo
    const generalFetchers = {
      aleatorio: fetchRandomQuestions,
      personalizado: fetchPersonalizedQuestions,
      rapido: fetchQuickQuestions,
      oficial: fetchOfficialQuestions
    }
    
    console.log(`‚ö° Test general sin tema espec√≠fico`)
    return generalFetchers[testType] || fetchRandomQuestions
  }

  // üî• Configuraciones predefinidas por tipo de test
  const getTestConfig = () => {
    const baseConfigs = {
      aleatorio: {
        name: "Test Aleatorio",
        description: "Preguntas mezcladas autom√°ticamente",
        color: "from-blue-500 to-cyan-600",
        icon: "üé≤",
        subtitle: "Orden completamente aleatorio",
        fetcher: getFetcherForTema(tema, 'aleatorio') // üéØ DETECCI√ìN AUTOM√ÅTICA
      },
      personalizado: {
        name: "Test Personalizado", 
        description: " ",
        color: "from-purple-500 to-indigo-600",
        icon: "‚ú®",
        fetcher: getFetcherForTema(tema, 'personalizado') // üéØ DETECCI√ìN AUTOM√ÅTICA
      },
      rapido: {
        name: "Test R√°pido",
        description: "Solo 10 preguntas",
        color: "from-green-500 to-emerald-600", 
        icon: "‚ö°",
        subtitle: "Pr√°ctica r√°pida en 5 minutos",
        fetcher: getFetcherForTema(tema, 'rapido') // üéØ DETECCI√ìN AUTOM√ÅTICA
      },
      oficial: {
        name: "Test Oficial",
        description: "Solo preguntas de ex√°menes reales",
        color: "from-red-500 to-pink-600",
        icon: "üèõÔ∏è", 
        subtitle: "Preguntas que aparecieron en ex√°menes oficiales",
        fetcher: getFetcherForTema(tema, 'oficial') // üéØ DETECCI√ìN AUTOM√ÅTICA
      },
      // üÜï NUEVOS TIPOS PARA NOTIFICACIONES
      'articulos-dirigido': {
        name: "Test Dirigido",
        description: "Art√≠culos problem√°ticos",
        color: "from-red-500 to-pink-600",
        icon: "üéØ",
        subtitle: "Enfocado en tus √°reas de mejora",
        fetcher: fetchArticulosDirigido // ‚úÖ USAR FUNCI√ìN ESPEC√çFICA
      },
      'mantener-racha': {
        name: "Mantener Racha",
        description: "Test para continuar estudiando",
        color: "from-yellow-500 to-orange-600",
        icon: "üî•",
        subtitle: "Mant√©n tu racha de estudio activa",
        fetcher: fetchMantenerRacha
      },
      'explorar': {
        name: "Explorar Contenido",
        description: "Nuevo contenido a√±adido",
        color: "from-blue-500 to-cyan-600",
        icon: "üîç",
        subtitle: "Descubre las √∫ltimas preguntas",
        fetcher: fetchExplorarContenido
      }
    }

    const baseConfig = baseConfigs[testType] || baseConfigs.aleatorio
    
    // üéØ Sobrescribir con props personalizadas
    const finalConfig = {
      ...baseConfig,
      name: customTitle || baseConfig.name,
      description: customDescription !== undefined ? customDescription : baseConfig.description,
      color: customColor || baseConfig.color,
      icon: customIcon || baseConfig.icon,
      subtitle: customSubtitle !== undefined ? customSubtitle : baseConfig.subtitle,
      ...defaultConfig
    }

    console.log('üîß getTestConfig resultado:', finalConfig)
    return finalConfig
  }

  // üîß Funci√≥n para obtener n√∫mero de test
  const getTestNumber = (testType) => {
    const testNumbers = {
      aleatorio: 1,
      personalizado: 99,
      rapido: 2,
      oficial: 3,
      // üÜï NUEVOS N√öMEROS PARA NOTIFICACIONES
      'articulos-dirigido': 88,
      'mantener-racha': 87,
      'explorar': 86
    }
    return testNumbers[testType] || 1
  }

  // üöÄ Funci√≥n principal de carga
  const loadQuestions = async () => {
    try {
      setLoading(true)
      setError(null)

      console.log('üöÄ TestPageWrapper: Cargando test', testType, 'para tema', tema)

      const testConfig = getTestConfig()
      console.log('üîß Config generado:', testConfig)
      setConfig(testConfig)

      // üéØ Usar fetcher del tipo de test
      const fetcher = testConfig.fetcher
      
      if (!fetcher) {
        throw new Error(`No hay fetcher configurado para el tipo de test: ${testType}`)
      }

      let questions = []

      // üÜï MANEJAR ARTICULOS-DIRIGIDO DE FORMA ESPECIAL
      if (testType === 'articulos-dirigido') {
        console.log('üéØ Cargando test dirigido con par√°metros:', {
          lawName,
          searchParams: finalSearchParams,
          articles: finalSearchParams?.get?.('articles'),
          mode: finalSearchParams?.get?.('mode'),
          n: finalSearchParams?.get?.('n')
        })

        // Llamar fetchArticulosDirigido con par√°metros espec√≠ficos
        questions = await fetchArticulosDirigido(lawName, finalSearchParams, testConfig)
      } else if (testType === 'aleatorio' && themes && themes.length > 0) {
        // üé≤ MANEJAR TEST ALEATORIO MULTI-TEMA
        console.log('üé≤ Cargando test aleatorio multi-tema con par√°metros:', {
          themes,
          searchParams: finalSearchParams,
          numQuestions: finalSearchParams?.get?.('n'),
          difficulty: finalSearchParams?.get?.('difficulty')
        })

        // Llamar fetchAleatorioMultiTema con temas espec√≠ficos
        questions = await fetchAleatorioMultiTema(themes, finalSearchParams, testConfig)
      } else {
        // Para otros tipos de test, usar el fetcher normal
        let finalTestConfig = testConfig
        
        // üéØ PARA TESTS PERSONALIZADOS: Extraer filtros de URL y agregarlos al config
        if (testType === 'personalizado') {
          const selectedLawsParam = finalSearchParams?.get?.('selected_laws')
          const selectedArticlesByLawParam = finalSearchParams?.get?.('selected_articles_by_law')
          
          
          let selectedLaws = []
          let selectedArticlesByLaw = {}
          
          try {
            selectedLaws = selectedLawsParam ? JSON.parse(selectedLawsParam) : []
            selectedArticlesByLaw = selectedArticlesByLawParam ? JSON.parse(selectedArticlesByLawParam) : {}
            
            // Agregar filtros al config que se pasa al fetcher
            finalTestConfig = {
              ...testConfig,
              selectedLaws,
              selectedArticlesByLaw
            }
            
            if (selectedLaws.length > 0) {
              console.log('üîß Filtros aplicados:', selectedLaws.length, 'leyes,', Object.keys(selectedArticlesByLaw).length, 'grupos de art√≠culos')
            }
          } catch (error) {
            console.error('‚ùå Error parsing filtros en TestPageWrapper:', error)
          }
        }
        
        questions = await fetcher(tema, finalSearchParams, finalTestConfig)
      }

      // üß† Verificar si es modo adaptativo o normal
      if (questions && questions.isAdaptive) {
        // Modo adaptativo - verificar estructura
        if (!questions.activeQuestions || questions.activeQuestions.length === 0) {
          throw new Error('No se encontraron preguntas activas para modo adaptativo')
        }
        setQuestions(questions) // Pasar toda la estructura adaptativa
        console.log('‚úÖ TestPageWrapper: Modo adaptativo cargado:', questions.activeQuestions.length, 'activas,', questions.questionPool.length, 'en pool')
      } else {
        // Modo normal - verificar array
        if (!questions || questions.length === 0) {
          throw new Error('No se encontraron preguntas con la configuraci√≥n actual')
        }
        setQuestions(questions)
        console.log('‚úÖ TestPageWrapper: Test cargado exitosamente:', questions.length, 'preguntas')
      }
      console.log('‚úÖ Config final aplicado:', testConfig)

    } catch (err) {
      console.error('‚ùå TestPageWrapper: Error cargando test:', err)
      setError(err.message || 'Error cargando el test')
    } finally {
      setLoading(false)
    }
  }

  // üîÑ Cargar preguntas al montar y cuando cambien los par√°metros
  useEffect(() => {
    loadQuestions()
  }, [tema, testType, finalSearchParams, lawName, themes]) // ‚úÖ AGREGAR lawName y themes a dependencias

  // üîÑ Estado de carga
  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-gray-900 dark:to-gray-800 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-3"></div>
          <p className="text-gray-600 dark:text-gray-300 text-sm">
            {loadingMessage || `üîÑ Preparando ${config?.name || 'test'}...`}
          </p>
          {config && (
            <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
              {config.icon} {config.name}
            </p>
          )}
          
          {/* Informaci√≥n espec√≠fica seg√∫n tipo */}
          {testType === 'personalizado' && (
            <div className="mt-3 space-y-1 text-xs text-blue-600 dark:text-blue-400">
              {finalSearchParams?.get?.('exclude_recent') === 'true' && (
                <p>üö´ Excluyendo preguntas de √∫ltimos {finalSearchParams?.get?.('recent_days') || 15} d√≠as</p>
              )}
              {finalSearchParams?.get?.('only_official') === 'true' && (
                <p>üèõÔ∏è Solo preguntas de ex√°menes oficiales</p>
              )}
              {finalSearchParams?.get?.('focus_weak') === 'true' && (
                <p>üéØ Analizando √°reas d√©biles</p>
              )}
            </div>
          )}
          
          {/* üÜï INFORMACI√ìN ESPEC√çFICA PARA TESTS DIRIGIDOS */}
          {testType === 'articulos-dirigido' && (
            <div className="mt-3 space-y-1 text-xs text-red-600 dark:text-red-400">
              <p>üéØ Test dirigido cargando...</p>
              {lawName && <p>üìö Ley: {lawName}</p>}
              {finalSearchParams?.get?.('articles') && (
                <p>üìã Art√≠culos: {finalSearchParams.get('articles').split(',').length}</p>
              )}
              {finalSearchParams?.get?.('mode') && (
                <p>‚öôÔ∏è Modo: {finalSearchParams.get('mode')}</p>
              )}
              {finalSearchParams?.get?.('notification_id') && (
                <p>üîî Desde notificaci√≥n</p>
              )}
            </div>
          )}
        </div>
      </div>
    )
  }

  // ‚ùå Estado de error
  if (error || questions.length === 0) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-gray-900 dark:to-gray-800 flex items-center justify-center">
        <div className="text-center max-w-md mx-auto">
          <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 p-6">
            <h2 className="text-xl font-bold text-red-600 dark:text-red-400 mb-3">
              {config?.icon || '‚ö†Ô∏è'} {config?.name || 'Test'} No Disponible
            </h2>
            <p className="text-gray-600 dark:text-gray-300 mb-3 text-sm">
              {errorMessage || error || 'No se encontraron preguntas con esta configuraci√≥n.'}
            </p>
            
            {/* üÜï INFORMACI√ìN ESPECIAL PARA ARTICULOS-DIRIGIDO */}
            {testType === 'articulos-dirigido' && (
              <div className="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 rounded-lg p-3 mb-4 text-left">
                <h4 className="font-bold text-red-800 dark:text-red-300 text-sm mb-2">Test dirigido:</h4>
                <ul className="text-xs text-red-700 dark:text-red-400 space-y-1">
                  {lawName && <li>üìö Ley: {lawName}</li>}
                  {finalSearchParams?.get?.('articles') && (
                    <li>üìã Art√≠culos: {finalSearchParams.get('articles')}</li>
                  )}
                  {finalSearchParams?.get?.('mode') && (
                    <li>‚öôÔ∏è Modo: {finalSearchParams.get('mode')}</li>
                  )}
                  {finalSearchParams?.get?.('n') && (
                    <li>üìù Preguntas solicitadas: {finalSearchParams.get('n')}</li>
                  )}
                </ul>
              </div>
            )}

            {/* Mostrar configuraci√≥n actual si es personalizado */}
            {testType === 'personalizado' && (
              <div className="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-lg p-3 mb-4 text-left">
                <h4 className="font-bold text-blue-800 dark:text-blue-300 text-sm mb-2">Tu configuraci√≥n:</h4>
                <ul className="text-xs text-blue-700 dark:text-blue-400 space-y-1">
                  <li>üìù Preguntas: {finalSearchParams?.get?.('n') || 25}</li>
                  <li>üéØ Dificultad: {finalSearchParams?.get?.('difficulty_mode') || 'aleatorio'}</li>
                  {finalSearchParams?.get?.('exclude_recent') === 'true' && (
                    <li>üö´ Excluir √∫ltimos {finalSearchParams?.get?.('recent_days') || 15} d√≠as</li>
                  )}
                  {finalSearchParams?.get?.('only_official') === 'true' && (
                    <li>üèõÔ∏è Solo preguntas oficiales</li>
                  )}
                  {finalSearchParams?.get?.('focus_weak') === 'true' && (
                    <li>üéØ Enfoque en √°reas d√©biles</li>
                  )}
                </ul>
              </div>
            )}

            <div className="space-y-3">
              <button 
                onClick={loadQuestions}
                className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm w-full"
              >
                üîÑ Reintentar
              </button>
              
              {/* üÜï BOTONES ESPEC√çFICOS PARA ARTICULOS-DIRIGIDO */}
              {testType === 'articulos-dirigido' && lawName && (
                <>
                  <a 
                    href={`/test/${encodeURIComponent(lawName)}/test-rapido?n=10`}
                    className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm inline-block w-full text-center"
                  >
                    ‚ö° Test r√°pido de {lawName}
                  </a>
                  <a 
                    href={`/teoria/${lawName.toLowerCase().replace(/\s+/g, '-')}`}
                    className="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors text-sm inline-block w-full text-center"
                  >
                    üìñ Ver teor√≠a de {lawName}
                  </a>
                </>
              )}
              
              {testType === 'personalizado' && (
                <a 
                  href={`/auxiliar-administrativo-estado/test/tema-${tema}`}
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm inline-block w-full text-center"
                >
                  üéõÔ∏è Cambiar configuraci√≥n
                </a>
              )}
              
              <a 
                href="/test/rapido"
                className="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors text-sm inline-block w-full text-center"
              >
                üé≤ Test r√°pido general
              </a>
              
              <a 
                href="/auxiliar-administrativo-estado/test"
                className="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 text-sm inline-block w-full text-center underline"
              >
                üè† Volver a Tests
              </a>
            </div>
          </div>
        </div>
      </div>
    )
  }

  // ‚úÖ Renderizar test exitoso
  return (
    <>
      <OposicionDetector />

      
      {/* ‚úÖ DEBUGGER: Mostrar valores actuales */}
      {console.log('üîç TestPageWrapper debug:', { 
        tema: tema || 0, 
        testNumber: getTestNumber(testType), 
        config, 
        questionsLength: questions.length,
        testType 
      })}
      
      <TestLayout
        tema={tema || 0}
        testNumber={getTestNumber(testType)}
        config={config || {
          name: `Test ${testType}`,
          description: 'Test de pr√°ctica',
          subtitle: `${questions.length} preguntas`,
          icon: 'üéØ',
          color: 'from-blue-500 to-cyan-600'
        }}
        questions={questions}
      />
    </>
  )
}