name: ğŸ“§ Motivational Emails Scheduler
  on:
    schedule:
      # Ejecutar cada 6 horas (0:00, 6:00, 12:00, 18:00 UTC)
      - cron: '0 */6 * * *'
    workflow_dispatch:
      # Permite ejecutar manualmente desde GitHub
      inputs:
        reason:
          description: 'RazÃ³n para ejecutar manualmente'
          required: false
          default: 'Manual trigger'

  jobs:
    send-motivational-emails:
      runs-on: ubuntu-latest
      name: ğŸ“§ Enviar emails motivacionales

      steps:
        - name: ğŸ“§ Send motivational emails
          env:
            CRON_SECRET: ${{ secrets.CRON_SECRET }}
          run: |
            echo "ğŸš€ Iniciando envÃ­o de emails motivacionales..."
            echo "â° Timestamp: $(date)"

            # Verificar que el secreto existe
            if [ -z "$CRON_SECRET" ]; then
              echo "âŒ CRON_SECRET estÃ¡ vacÃ­o o no existe"
              exit 1
            fi
            echo "âœ… CRON_SECRET configurado (${#CRON_SECRET} chars)"

            # Test directo con verbose para debug
            echo "ğŸ” Testing debug endpoint with verbose output..."
            curl -X POST \
              -H "Authorization: Bearer ${CRON_SECRET}" \
              -H "Content-Type: application/json" \
              -v \
              https://vence.es/api/debug/cron-auth

            echo ""
            echo "ğŸš€ Calling main endpoint..."
            response=$(curl -X POST \
              -H "Authorization: Bearer ${CRON_SECRET}" \
              -H "Content-Type: application/json" \
              -w "\n%{http_code}" \
              -s \
              https://vence.es/api/emails/send-motivational-scheduled)

            # Separar body y status code
            http_code=$(echo "$response" | tail -n1)
            response_body=$(echo "$response" | head -n -1)

            echo "ğŸ“Š HTTP Status: $http_code"
            echo "ğŸ“„ Response: $response_body"

            # Verificar si fue exitoso
            if [ $http_code -eq 200 ]; then
              echo "âœ… Emails motivacionales enviados exitosamente"
            else
              echo "âŒ Error enviando emails motivacionales"
              exit 1
            fi

        - name: ğŸ“Š Log execution details
          if: always()
          run: |
            echo "ğŸ·ï¸ Workflow triggered by: ${{ github.event_name }}"
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              echo "ğŸ“ Manual trigger reason: ${{ github.event.inputs.reason }}"
            fi
