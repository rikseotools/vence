name: 📧 Motivational Emails Scheduler
  on:
    schedule:
      # Ejecutar cada 6 horas (0:00, 6:00, 12:00, 18:00 UTC)
      - cron: '0 */6 * * *'
    workflow_dispatch:
      # Permite ejecutar manualmente desde GitHub
      inputs:
        reason:
          description: 'Razón para ejecutar manualmente'
          required: false
          default: 'Manual trigger'

  jobs:
    send-motivational-emails:
      runs-on: ubuntu-latest
      name: 📧 Enviar emails motivacionales

      steps:
        - name: 📧 Send motivational emails
          env:
            CRON_SECRET: ${{ secrets.CRON_SECRET }}
          run: |
            echo "🚀 Iniciando envío de emails motivacionales..."
            echo "⏰ Timestamp: $(date)"

            # Verificar que el secreto existe
            if [ -z "$CRON_SECRET" ]; then
              echo "❌ CRON_SECRET está vacío o no existe"
              exit 1
            fi
            echo "✅ CRON_SECRET configurado (${#CRON_SECRET} chars)"

            # Test directo con verbose para debug
            echo "🔍 Testing debug endpoint with verbose output..."
            curl -X POST \
              -H "Authorization: Bearer ${CRON_SECRET}" \
              -H "Content-Type: application/json" \
              -v \
              https://vence.es/api/debug/cron-auth

            echo ""
            echo "🚀 Calling main endpoint..."
            response=$(curl -X POST \
              -H "Authorization: Bearer ${CRON_SECRET}" \
              -H "Content-Type: application/json" \
              -w "\n%{http_code}" \
              -s \
              https://vence.es/api/emails/send-motivational-scheduled)

            # Separar body y status code
            http_code=$(echo "$response" | tail -n1)
            response_body=$(echo "$response" | head -n -1)

            echo "📊 HTTP Status: $http_code"
            echo "📄 Response: $response_body"

            # Verificar si fue exitoso
            if [ $http_code -eq 200 ]; then
              echo "✅ Emails motivacionales enviados exitosamente"
            else
              echo "❌ Error enviando emails motivacionales"
              exit 1
            fi

        - name: 📊 Log execution details
          if: always()
          run: |
            echo "🏷️ Workflow triggered by: ${{ github.event_name }}"
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              echo "📝 Manual trigger reason: ${{ github.event.inputs.reason }}"
            fi
