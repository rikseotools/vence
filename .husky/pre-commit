#!/bin/sh
# .husky/pre-commit
# Hook para ejecutar validaciones antes de commit

echo "üîç Ejecutando validaciones pre-commit..."
echo ""

# 1. Verificar schema drift (si DATABASE_URL disponible)
if [ -n "$DATABASE_URL" ]; then
  echo "üìä Verificando sincronizaci√≥n schema vs BD..."
  npm run db:check
  SCHEMA_EXIT_CODE=$?

  if [ $SCHEMA_EXIT_CODE -ne 0 ]; then
    echo ""
    echo "‚ö†Ô∏è  Schema desincronizado. Ver errores arriba."
    echo "   Para sincronizar: npm run db:pull"
    echo ""
    # Solo warning, no bloquea el commit
  fi
else
  echo "‚è≠Ô∏è  Saltando verificaci√≥n de schema (DATABASE_URL no configurada)"
fi

echo ""

# 2. Ejecutar tests
echo "üß™ Ejecutando tests..."
npm run test:ci
TEST_EXIT_CODE=$?

if [ $TEST_EXIT_CODE -ne 0 ]; then
  echo ""
  echo "‚ùå Tests fallaron. Commit cancelado."
  echo ""
  echo "üí° Para solucionar:"
  echo "   1. Revisa los tests que fallan con: npm test"
  echo "   2. Corrige los problemas"
  echo "   3. Intenta el commit nuevamente"
  echo ""
  exit 1
fi

echo ""
echo "‚úÖ Todas las validaciones pasaron. Continuando con el commit..."
