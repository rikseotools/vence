#!/bin/sh
# .husky/pre-commit
# Hook para ejecutar validaciones antes de commit

echo "üîç Ejecutando validaciones pre-commit..."
echo ""

# 1. Verificar schema drift (si DATABASE_URL disponible)
if [ -n "$DATABASE_URL" ]; then
  echo "üìä Verificando sincronizaci√≥n schema vs BD..."
  npm run db:check
  SCHEMA_EXIT_CODE=$?

  if [ $SCHEMA_EXIT_CODE -ne 0 ]; then
    echo ""
    echo "‚ö†Ô∏è  Schema desincronizado. Ver errores arriba."
    echo "   Para sincronizar: npm run db:pull"
    echo ""
    # Solo warning, no bloquea el commit
  fi
else
  echo "‚è≠Ô∏è  Saltando verificaci√≥n de schema (DATABASE_URL no configurada)"
fi

echo ""

# 2. Verificar patrones de bug conocidos
echo "üîé Verificando patrones de bugs conocidos..."

# Bug: guardar correctCount como score en vez de porcentaje
# Patr√≥n: score: correctCount.toString() o score: correct.toString()
BUGGY_PATTERN=$(grep -rn "score:.*\(correctCount\|correct\)\.toString()" lib/ app/api/ 2>/dev/null | grep -v "scorePercentage\|score\.toString()" || true)

if [ -n "$BUGGY_PATTERN" ]; then
  echo ""
  echo "‚ö†Ô∏è  POSIBLE BUG DETECTADO: score guardando conteo en vez de porcentaje"
  echo ""
  echo "$BUGGY_PATTERN"
  echo ""
  echo "üí° El score debe ser un PORCENTAJE (0-100), no el n√∫mero de correctas."
  echo "   Usa: score: scorePercentage.toString() o score: Math.round((correct/total)*100).toString()"
  echo ""
  # Warning, no bloquea (podr√≠a ser falso positivo)
fi

echo ""

# 3. Ejecutar tests
echo "üß™ Ejecutando tests..."
npm run test:ci
TEST_EXIT_CODE=$?

if [ $TEST_EXIT_CODE -ne 0 ]; then
  echo ""
  echo "‚ùå Tests fallaron. Commit cancelado."
  echo ""
  echo "üí° Para solucionar:"
  echo "   1. Revisa los tests que fallan con: npm test"
  echo "   2. Corrige los problemas"
  echo "   3. Intenta el commit nuevamente"
  echo ""
  exit 1
fi

echo ""
echo "‚úÖ Todas las validaciones pasaron. Continuando con el commit..."
