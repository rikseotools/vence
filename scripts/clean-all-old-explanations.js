// scripts/clean-all-old-explanations.js
// Limpiar TODAS las explicaciones viejas que causan conflicto

import { createClient } from '@supabase/supabase-js'

const supabaseUrl = 'https://yqbpstxowvgipqspqrgo.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxYnBzdHhvd3ZnaXBxc3BxcmdvIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MDg3NjcwMywiZXhwIjoyMDY2NDUyNzAzfQ.4yUKsfS-enlY6iGICFkKi-HPqNUyTkHczUqc5kgQB3w'

const supabase = createClient(supabaseUrl, supabaseKey)

async function cleanAllOldExplanations() {
  const questionId = '588c79ed-05fa-421a-8f32-23e4038b700b'
  
  console.log('üßπ Limpiando TODAS las explicaciones viejas con errores...')

  try {
    const { data: currentQuestion, error: fetchError } = await supabase
      .from('psychometric_questions')
      .select('content_data')
      .eq('id', questionId)
      .single()

    if (fetchError || !currentQuestion) {
      console.error('‚ùå Error obteniendo pregunta:', fetchError)
      return
    }

    // Crear content_data completamente limpio - solo con lo esencial y correcto
    const cleanContentData = {
      exam_tip: "En gr√°ficos de l√≠neas: 1) Identifica la serie correcta por color/leyenda, 2) Localiza el punto exacto, 3) Lee el valor con precisi√≥n, 4) Suma todos los valores de esa categor√≠a.",
      subtitle: "(en miles) al mes",
      age_groups: currentQuestion.content_data.age_groups,
      categories: currentQuestion.content_data.categories,
      chart_type: "line_chart",
      chart_title: "Personas atendidas por rango de edad / lugar de la atenci√≥n",
      x_axis_label: "Tipo de centro",
      y_axis_label: "N√∫mero de personas (miles)",
      question_context: "Observa el siguiente gr√°fico de l√≠neas que muestra la distribuci√≥n de pacientes por edad y tipo de centro:",
      target_group_value: 50,
      total_target_center: 210,
      evaluation_description: "Tu capacidad para interpretar gr√°ficos de l√≠neas con m√∫ltiples series y calcular porcentajes espec√≠ficos.",
      
      // √öNICA explicaci√≥n correcta y completa
      explanation_sections: [
        {
          title: "üìä AN√ÅLISIS PASO A PASO - GR√ÅFICO DE L√çNEAS:",
          content: `üìã Paso 1: Localizar la serie correcta en el gr√°fico

‚Ä¢ Buscar columna: "Centros de especialidades" (3¬™ columna)
‚Ä¢ Buscar l√≠nea: "27-59 a√±os" (l√≠nea m√°s oscura)  
‚Ä¢ Leer valor exacto donde se cruzan: 50 (miles de personas)


üìã Paso 2: Obtener total de pacientes en Centros de especialidades

‚Ä¢ 0-1 a√±os: 70 mil
‚Ä¢ 15-26 a√±os: 30 mil
‚Ä¢ 27-59 a√±os: 50 mil
‚Ä¢ 60+ a√±os: 60 mil
‚Ä¢ Total: 70 + 30 + 50 + 60 = 210 mil personas


üìã Paso 3: Calcular el porcentaje EXACTO

‚Ä¢ F√≥rmula: (Parte √∑ Total) √ó 100
‚Ä¢ Aplicado: (50 √∑ 210) √ó 100
‚Ä¢ Resultado: 23.809523... %
‚Ä¢ Respuesta m√°s cercana: 23,8% ‚úÖ`
        },
        {
          title: "‚ö° T√âCNICAS DE C√ÅLCULO MENTAL (Para oposiciones)",
          content: `üîç M√©todo 1: Estimaci√≥n visual r√°pida

‚Ä¢ 50 de 210 es aproximadamente 1/4 del total
‚Ä¢ 1/4 = 25%, as√≠ que el resultado debe estar cerca del 25%
‚Ä¢ Entre las opciones, 23,8% es la m√°s cercana a 25%


üßÆ M√©todo 2: Simplificaci√≥n por aproximaci√≥n

‚Ä¢ 50 √∑ 210 ‚âà 50 √∑ 200 = 1/4 = 25%
‚Ä¢ Pero como 210 > 200, el resultado ser√° algo menor que 25%
‚Ä¢ 23,8% es coherente con esta l√≥gica


üí° M√©todo 3: C√°lculo mental directo

‚Ä¢ 50 √∑ 210 = 5 √∑ 21  
‚Ä¢ 5 √∑ 20 = 0,25 = 25%
‚Ä¢ Como 21 > 20, el resultado ser√° menor: ~23,8%


üö® M√©todo 4: Descarte por l√≥gica

‚Ä¢ A) 22% - Cerca pero algo bajo
‚Ä¢ B) 23,8% - Es el m√°s cercano al c√°lculo exacto ‚úÖ
‚Ä¢ C) 21,80% - Demasiado bajo para 50/210  
‚Ä¢ D) 20,83% - Muy bajo, claramente incorrecto`
        }
      ]
    }

    const { error: updateError } = await supabase
      .from('psychometric_questions')
      .update({ content_data: cleanContentData })
      .eq('id', questionId)

    if (updateError) {
      console.error('‚ùå Error actualizando pregunta:', updateError)
      return
    }

    console.log('‚úÖ Todas las explicaciones viejas eliminadas')
    console.log('üßπ Propiedades conflictivas removidas:')
    console.log('   - quick_method_1, quick_method_2, quick_method_3')
    console.log('   - common_errors')
    console.log('   - Cualquier referencia a 20,83%')
    console.log('')
    console.log('‚úÖ Solo queda la explicaci√≥n correcta y exacta')
    console.log('üìä Resultado: (50 √∑ 210) √ó 100 = 23.809...% ‚Üí 23,8%')
    console.log('')
    console.log('üîó REVISAR PREGUNTA LIMPIA:')
    console.log(`   http://localhost:3000/debug/question/${questionId}`)

  } catch (err) {
    console.error('‚ùå Error general:', err)
  }
}

cleanAllOldExplanations()